<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Data Analysis Note - Pandas Part 3 - Groupby | K.Z.&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="This post covers useful notes for using pandas (the famous package for Python for data analysis). This post are more advanced topics such as group dataframe, group data with custom python functions an">
<meta property="og:type" content="article">
<meta property="og:title" content="Data Analysis Note - Pandas Part 3 - Groupby">
<meta property="og:url" content="https://k-z007.github.io/2023/08/13/pandas-useful-notes-advanced/index.html">
<meta property="og:site_name" content="K.Z.&#39;s Blog">
<meta property="og:description" content="This post covers useful notes for using pandas (the famous package for Python for data analysis). This post are more advanced topics such as group dataframe, group data with custom python functions an">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-08-13T06:10:08.000Z">
<meta property="article:modified_time" content="2024-05-22T06:28:25.100Z">
<meta property="article:author" content="K.Z.">
<meta property="article:tag" content="data_analysis">
<meta property="article:tag" content="pandas">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="K.Z.'s Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">K.Z.&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://k-z007.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-pandas-useful-notes-advanced" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/08/13/pandas-useful-notes-advanced/" class="article-date">
  <time class="dt-published" datetime="2023-08-13T06:10:08.000Z" itemprop="datePublished">2023-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Data Analysis Note - Pandas Part 3 - Groupby
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>This post covers useful notes for using pandas (the famous package for Python for data analysis). This post are more advanced topics such as group dataframe, group data with custom python functions and join dataframe etc. </p>
<p><strong>1. Groupby dataframe :</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#This is a best way to find if this column has any null values or not:</span></span><br><span class="line"><span class="comment">#It is good practice to check if a column has null before groupby:</span></span><br><span class="line">df.name.isnull().<span class="built_in">any</span>()</span><br><span class="line"></span><br><span class="line">movies_gb_rating = movies.groupby(<span class="string">&#x27;rating&#x27;</span>)</span><br><span class="line"></span><br><span class="line">movies_gb_rating.ngroups <span class="comment"># return the number of groups totally</span></span><br><span class="line"></span><br><span class="line">movies_gb_rating.groups  </span><br><span class="line"><span class="comment"># return a python dictionary with key and value (key is the group name and value is a list of contained rows&#x27; indexes)</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; results -&gt;</span><br><span class="line"><span class="string">&#x27;G&#x27;</span>: [<span class="number">107</span>, <span class="number">933</span>, <span class="number">1126</span>, <span class="number">1557</span>, <span class="number">2911</span>, <span class="number">3059</span>, ], <span class="string">&#x27;NC-17&#x27;</span>: [<span class="number">5264</span>, <span class="number">6338</span>, <span class="number">7263</span>], <span class="string">&#x27;NR&#x27;</span>: [<span class="number">5971</span>, <span class="number">5987</span>, <span class="number">6015</span>, <span class="number">6054</span>, <span class="number">6087</span>, <span class="number">6093</span>, <span class="number">6095</span>, <span class="number">6179</span>, <span class="number">6190</span>, <span class="number">6207</span>, <span class="number">6208</span>, <span class="number">6226</span>], <span class="string">&#x27;PG&#x27;</span>: [<span class="number">6</span>, <span class="number">41</span>, <span class="number">42</span>, <span class="number">43</span>, <span class="number">45</span>, <span class="number">94</span>, <span class="number">115</span>, <span class="number">127</span>, <span class="number">137</span>, <span class="number">155</span>, <span class="number">156</span>, <span class="number">167</span>, <span class="number">168</span>, <span class="number">231</span>, <span class="number">300</span>, <span class="number">325</span>, <span class="number">326</span>, <span class="number">330</span>, <span class="number">344</span>, <span class="number">345</span>, <span class="number">347</span>, <span class="number">393</span>, ...], <span class="string">&#x27;PG-13&#x27;</span>: [<span class="number">0</span>, <span class="number">9</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">38</span>, <span class="number">44</span>, <span class="number">88</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">128</span>, <span class="number">129</span>, <span class="number">134</span>, <span class="number">138</span>, <span class="number">142</span>, , ...], </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">movies_gb_rating.first()   <span class="comment"># get the first result from all groups into a dataframe:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get all results (a dataframe) that belongs to this specific group;</span></span><br><span class="line">movies_gb_rating.get_group(<span class="string">&#x27;G&#x27;</span>)     <span class="comment"># this is similar to filter the result by rating == &#x27;G&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate through all groups and print the group name and results </span></span><br><span class="line"><span class="keyword">for</span> name, group <span class="keyword">in</span> movies_gb_rating:</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(group)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouped_df = df.groupby(<span class="string">&#x27;student&#x27;</span>).grade.mean()</span><br><span class="line">grouped_df = df.groupby(<span class="string">&#x27;student&#x27;</span>, as_index=<span class="literal">False</span>).grade.mean() <span class="comment"># as_index=False means -- Do not set the &#x27;student&#x27; column as index;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#column1 is the column that we want to group by (&#x27;student&#x27; in our example)</span></span><br><span class="line"><span class="comment">#column2 is the column that we want to perform a measurement on (grade in our example)</span></span><br><span class="line"><span class="comment">#measurement is the measurement function we want to apply (mean in our example)</span></span><br><span class="line">df.groupby(<span class="string">&#x27;column1&#x27;</span>).column2.measurement()</span><br><span class="line">pricey_shoes = orders.groupby(<span class="string">&quot;shoe_type&quot;</span>).price.<span class="built_in">max</span>()  <span class="comment"># type is &lt;class &#x27;pandas.core.series.Series&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># using reset_index() function to reset the index and convert to a DataFrame (books dataframe),</span></span><br><span class="line"><span class="comment"># withou reset_index() it will be a series</span></span><br><span class="line">df = books.groupby(<span class="string">&#x27;Genre&#x27;</span>)[<span class="string">&#x27;Price&#x27;</span>].<span class="built_in">max</span>().reset_index()</span><br><span class="line">df &gt;&gt; </span><br><span class="line">       Genre	    Price</span><br><span class="line">    <span class="number">0</span>	Fiction	    <span class="number">82</span></span><br><span class="line">    <span class="number">1</span>	Non Fiction	<span class="number">105</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rename the column &#x27;Price&#x27; to &quot;Max_price&quot;</span></span><br><span class="line">output.rename(columns = &#123;<span class="string">&quot;Price&quot;</span>: <span class="string">&quot;Max_price&quot;</span>&#125;,  inplace = <span class="literal">True</span>) </span><br><span class="line"></span><br><span class="line">df &gt;&gt; </span><br><span class="line">     	    Genre	    Max_price</span><br><span class="line">        <span class="number">0</span>	Fiction	    <span class="number">82</span></span><br><span class="line">        <span class="number">1</span>	Non Fiction	<span class="number">105</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Following command groups the books by year, calculates the number of authors and the max and average prices for each year, renames the columns, and sorts the results. The output is a sorted DataFrame where each row corresponds to a unique year and the columns are the calculated values.</span></span><br><span class="line"><span class="meta">@sort_values()</span></span><br><span class="line"> books.fillna(<span class="number">0</span>).groupby(<span class="string">&#x27;Year&#x27;</span>).agg(&#123;<span class="string">&#x27;Author&#x27;</span>:<span class="string">&#x27;count&#x27;</span>, <span class="string">&#x27;Price&#x27;</span>:[<span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>]&#125;)\</span><br><span class="line">            .rename(columns=&#123;<span class="string">&quot;count&quot;</span>:<span class="string">&#x27;num_of_authers&#x27;</span>, <span class="string">&quot;sum&quot;</span>:<span class="string">&#x27;max_price&#x27;</span>,<span class="string">&quot;mean&quot;</span>:<span class="string">&#x27;avg_price&#x27;</span>&#125;)\</span><br><span class="line">           .sort_values(by=[(<span class="string">&#x27;Author&#x27;</span>, <span class="string">&#x27;num_of_authers&#x27;</span>), (<span class="string">&#x27;Price&#x27;</span>, <span class="string">&#x27;avg_price&#x27;</span>)], ascending=[<span class="literal">False</span>, <span class="literal">True</span>])</span><br><span class="line">&gt;&gt; result -&gt; </span><br><span class="line">            Author	            Price</span><br><span class="line">         num_of_authers  max_price	avg_price</span><br><span class="line">    Year			</span><br><span class="line">    <span class="number">2019</span>	<span class="number">50</span>	            <span class="number">27</span>	        <span class="number">10.08</span></span><br><span class="line">    <span class="number">2015</span>	<span class="number">50</span>	            <span class="number">46</span>	        <span class="number">10.42</span></span><br><span class="line">    <span class="number">2018</span>	<span class="number">50</span>	            <span class="number">46</span>	        <span class="number">10.52</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># for instance, in 2019 there are 50 authers who publsih books recorded in this dataset and the max price (higest price of book sold in that year is) $27 and average price of that year is $10.08 </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2. Group data practical usage: agg function</strong></p>
<span id="more"></span>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Groupby certain conditions (&#x27;Continent&#x27; in this case) to get a groupby generater obj, then using key (&#x27;Continent name&#x27;) to access each item:</span></span><br><span class="line">grouped_by_genre = books.groupby(<span class="string">&#x27;Genre&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> key, group <span class="keyword">in</span> grouped_by_genre:</span><br><span class="line">    <span class="built_in">print</span>(key, <span class="built_in">type</span>(group))</span><br><span class="line"></span><br><span class="line"><span class="comment"># The above code get the following result:	</span></span><br><span class="line">        Fiction &lt;<span class="keyword">class</span> <span class="string">&#x27;pandas.core.frame.DataFrame&#x27;</span>&gt;</span><br><span class="line">        Non Fiction &lt;<span class="keyword">class</span> <span class="string">&#x27;pandas.core.frame.DataFrame&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># to print out each columns for the group object:</span></span><br><span class="line"><span class="keyword">for</span> key, group <span class="keyword">in</span> grouped_by_genre:</span><br><span class="line">    <span class="built_in">print</span>(key, group.columns)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The above code get the following result:	</span></span><br><span class="line">Fiction Index([<span class="string">&#x27;Name&#x27;</span>, <span class="string">&#x27;Author&#x27;</span>, <span class="string">&#x27;User Rating&#x27;</span>, <span class="string">&#x27;Reviews&#x27;</span>, <span class="string">&#x27;Price&#x27;</span>, <span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;Genre&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">Non Fiction Index([<span class="string">&#x27;Name&#x27;</span>, <span class="string">&#x27;Author&#x27;</span>, <span class="string">&#x27;User Rating&#x27;</span>, <span class="string">&#x27;Reviews&#x27;</span>, <span class="string">&#x27;Price&#x27;</span>, <span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;Genre&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@agg()  </span><span class="comment"># with customized function:  </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">price_range</span>(<span class="params">s</span>):   <span class="comment">#-&gt; get the price range</span></span><br><span class="line">    <span class="keyword">return</span> s.<span class="built_in">max</span>() - s.<span class="built_in">min</span>()</span><br><span class="line"></span><br><span class="line">grouped_by_genre[<span class="string">&#x27;Price&#x27;</span>].agg([<span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, price_range])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_nulls</span>(<span class="params">s</span>):   <span class="comment">#-&gt; get the null value per group</span></span><br><span class="line">    <span class="keyword">return</span> s.size - s.count()</span><br><span class="line"></span><br><span class="line">grouped_by_genre[<span class="string">&#x27;director&#x27;</span>].agg(count_nulls)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>3. Group data advanced usage: apply function</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@apply()</span></span><br><span class="line"><span class="comment"># using groupby to combine with apply() function. </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find 100 percentile of the book price in different &#x27;Genre&#x27; groups (aka highest price):</span></span><br><span class="line">expensive_books=books.groupby(<span class="string">&quot;Genre&quot;</span>).Price.apply(<span class="keyword">lambda</span> x: np.percentile(x,<span class="number">100</span>)).reset_index()</span><br><span class="line">expensive_books</span><br><span class="line">&gt;&gt;   </span><br><span class="line">    	    Genre	     Price</span><br><span class="line">        <span class="number">0</span>	Fiction	     <span class="number">82.0</span></span><br><span class="line">        <span class="number">1</span>	Non Fiction	 <span class="number">105.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find 25 percentile of the book price in different &#x27;Genre&#x27; groups (aka cheap books price):</span></span><br><span class="line">cheap_books=books.groupby(<span class="string">&quot;Genre&quot;</span>).Price.apply(<span class="keyword">lambda</span> x: np.percentile(x,<span class="number">25</span>)).reset_index()</span><br><span class="line">cheap_books</span><br><span class="line">&gt;&gt; </span><br><span class="line">    	    Genre	     Price</span><br><span class="line">        <span class="number">0</span>	Fiction	     <span class="number">6.0</span></span><br><span class="line">        <span class="number">1</span>	Non Fiction	 <span class="number">8.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find 50 percentile of the book price in different &#x27;Genre&#x27; groups (aka median books price):</span></span><br><span class="line">median_books=books.groupby(<span class="string">&quot;Genre&quot;</span>).Price.apply(<span class="keyword">lambda</span> x: np.percentile(x,<span class="number">50</span>)).reset_index()</span><br><span class="line">median_books</span><br><span class="line">&gt;&gt; </span><br><span class="line">    	    Genre	     Price</span><br><span class="line">        <span class="number">0</span>	Fiction	     <span class="number">9.0</span></span><br><span class="line">        <span class="number">1</span>	Non Fiction	 <span class="number">12.0</span></span><br><span class="line"><span class="comment"># above is the same to &quot;books.groupby(&#x27;Genre&#x27;)[&#x27;Price&#x27;].median()&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># calculate the proportion of book names in each genre that contain the word ‘love’.</span></span><br><span class="line">books.groupby(<span class="string">&#x27;Genre&#x27;</span>).Name.apply(<span class="keyword">lambda</span> s: s.<span class="built_in">str</span>.lower().<span class="built_in">str</span>.contains(<span class="string">&#x27;love&#x27;</span>) .<span class="built_in">sum</span>()/s.count())</span><br><span class="line">&gt;&gt; </span><br><span class="line">        Genre           </span><br><span class="line">        Fiction        <span class="number">0.008333</span></span><br><span class="line">        Non Fiction    <span class="number">0.067742</span></span><br><span class="line">        Name: Name, dtype: float64</span><br><span class="line"><span class="comment"># books.groupby(&#x27;Genre&#x27;): This groups the books DataFrame by the ‘Genre’ column. Each group corresponds to a unique genre.</span></span><br><span class="line"><span class="comment">#.Name.apply(lambda s: s.str.lower().str.contains(&#x27;love&#x27;).sum()/s.count()): This applies a function to the ‘Name’ column of each group. The function does the following:</span></span><br><span class="line">    <span class="comment">#s.str.lower(): Converts all the book names in the group to lowercase.</span></span><br><span class="line">    <span class="comment">#.str.contains(&#x27;love&#x27;): Checks if the word ‘love’ is in each book name. This returns a Series of True/False values.</span></span><br><span class="line">    <span class="comment">#.sum(): Counts the number of True values, i.e., the number of book names that contain ‘love’.</span></span><br><span class="line">    <span class="comment">#/s.count(): Divides the count by the total number of books in the group.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">books.groupby(<span class="string">&#x27;Genre&#x27;</span>).apply(<span class="keyword">lambda</span> df: (df[<span class="string">&#x27;Reviews&#x27;</span>] / df[<span class="string">&#x27;User Rating&#x27;</span>]).mean(), include_groups=<span class="literal">False</span>).sort_values()</span><br><span class="line"><span class="comment"># books.groupby(&#x27;Genre&#x27;): This groups the books DataFrame by the ‘Genre’ column. Each group corresponds to a unique Genre.</span></span><br><span class="line"><span class="comment"># .apply(lambda df: (df[&#x27;Reviews&#x27;] / df[&#x27;User Rating&#x27;]), include_groups=False): This applies a function to each group. The function does the following:</span></span><br><span class="line">        <span class="comment"># (df[&#x27;Reviews&#x27;] / df[&#x27;User Rating&#x27;]): For each group (i.e., for each year), it divides the ‘Reviews’ column by the ‘User Rating’ column. This operation is performed element-wise, get a result of how many reivews can generate 1 User Rating.</span></span><br><span class="line">        <span class="comment"># include_groups=False: This is an option for the apply() function. By setting it to False, the ‘Genre’ column (the grouping column) is excluded from the operation.</span></span><br><span class="line">        <span class="comment"># .sort_values(): This sorts the resulting Series in ascending order.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#This will add a new column ‘Max_Price_By_Genre’ to the books DataFrame. The transform() function</span></span><br><span class="line"><span class="comment"># applies a function to each group of values. In this case, it’s applying the ‘max’ function, which returns the maximum value for that genre, and then assign it back to the corresponding row.</span></span><br><span class="line"></span><br><span class="line">books[<span class="string">&#x27;Max_Price_By_Genre&#x27;</span>] = books.groupby(<span class="string">&#x27;Genre&#x27;</span>)[<span class="string">&#x27;Price&#x27;</span>].transform(<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">&gt;&gt;result -&gt;</span><br><span class="line">    	Name	Author	  User Rating	Reviews	Price	Year	Genre	     Max_Price_By_Genre</span><br><span class="line"><span class="number">0</span>	bookname1	JJ Smith	<span class="number">4.7</span>     	<span class="number">17350</span>	<span class="number">8</span>	    <span class="number">2016</span>	Non Fiction	   <span class="number">105</span></span><br><span class="line"><span class="number">1</span>	bookname2	Stephen 	<span class="number">4.6</span>	        <span class="number">2052</span>	<span class="number">22</span>	    <span class="number">2011</span>	Fiction	       <span class="number">82</span></span><br><span class="line"><span class="number">2</span>	bookname3	Jordan B    <span class="number">4.7</span>	        <span class="number">18979</span>	<span class="number">15</span>	    <span class="number">2018</span>	Non Fiction	   <span class="number">105</span></span><br><span class="line"><span class="number">3</span>	bookname4	George O	<span class="number">4.7</span>	        <span class="number">21424</span>	<span class="number">6</span>	    <span class="number">2017</span>	Fiction	       <span class="number">82</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@filter()  </span><span class="comment"># this filter is working with groupby(): </span></span><br><span class="line"><span class="comment">#groupby &#x27;year&#x27;, then using groupby result to check mean price to filter entre dataframe, note it returned df is the filtered df based on original df, not the groupby one:</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_price</span>(<span class="params">df</span>):</span><br><span class="line">    <span class="keyword">return</span> df[<span class="string">&#x27;Price&#x27;</span>].mean() &gt; <span class="number">15</span></span><br><span class="line"></span><br><span class="line">books.groupby(<span class="string">&#x27;Year&#x27;</span>).<span class="built_in">filter</span>(filter_price)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>3. Reduce data size by ‘category’ datatype:</strong><br>NOTE: Only suitable to columns that have limited types of string value, for instance for a type column in movies dataframe; or for gender types of student dataframe and the likes.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using &#x27;category&#x27; can massively reduce the size of a dataframe :</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;if certain column&#x27;s type is object and that dataframe has big size, then following way can convert certain column from &#x27;object&#x27; to &#x27;category&#x27; datatype, in essence, it will convert original string into int (which will mapping to certain dictionary of types), thus categorize the values&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># internal logic is the column now stores values of integer instead string, and each int value mapping to a corresponding type of original string in a lookup dictionary. For instance following method will convert the &#x27;type&#x27; column of a &#x27;movies&#x27; dataframe into a category. </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This line will convert the column &#x27;type&#x27; to datatype of &#x27;category&#x27; </span></span><br><span class="line">movies[<span class="string">&#x27;type&#x27;</span>] = movies[<span class="string">&#x27;type&#x27;</span>].astype(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># inspect the code value stored in this column, </span></span><br><span class="line">movies[<span class="string">&#x27;type&#x27;</span>].cat.codes.head()   <span class="comment"># will be different from df[&#x27;type&#x27;];</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Or you can convert when reading the df:</span></span><br><span class="line">dtypes = &#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;category&quot;</span>&#125;</span><br><span class="line">movies = pd.read_csv(<span class="string">r&quot;.\database\movies.csv&quot;</span>, dtype=dtypes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sort value with Category type with custom order (Customized order):</span></span><br><span class="line"><span class="comment"># Convert to ordered categorical type with custom ordering: [&#x27;North America&#x27; &lt; &#x27;Asia&#x27; &lt; &#x27;Europe&#x27; &lt; &#x27;Oceania&#x27; &lt; &#x27;South America&#x27; &lt; &#x27;Africa&#x27;]</span></span><br><span class="line">cat_dtype = pd.api.types.CategoricalDtype(categories=[<span class="string">&quot;North America&quot;</span>, <span class="string">&quot;Asia&quot;</span>, <span class="string">&quot;Europe&quot;</span>, <span class="string">&quot;Oceania&quot;</span>, <span class="string">&quot;South America&quot;</span>, <span class="string">&quot;Africa&quot;</span>], ordered=<span class="literal">True</span>)</span><br><span class="line">df[<span class="string">&quot;continent&quot;</span>] = df.continent.astype(cat_dtype) <span class="comment"># Categories (6, object): [&#x27;North America&#x27; &lt; &#x27;Asia&#x27; &lt; &#x27;Europe&#x27; &lt; &#x27;Oceania&#x27; &lt; &#x27;South America&#x27; &lt; &#x27;Africa&#x27;]</span></span><br><span class="line"><span class="comment"># then you can use the above to sort value;</span></span><br><span class="line">df_big.continent.sort_values()</span><br><span class="line"><span class="comment"># And you can use the above to filter values:</span></span><br><span class="line">df_big.loc[df_big.continent &gt; <span class="string">&quot;Oceania&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://k-z007.github.io/2023/08/13/pandas-useful-notes-advanced/" data-id="clxyavpkq000bf0jfd09v3oei" data-title="Data Analysis Note - Pandas Part 3 - Groupby" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-analysis/" rel="tag">data_analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pandas/" rel="tag">pandas</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/10/15/pandas-useful-notes-p3/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Data Analysis Note - Pandas Part 4 - Join Tables
        
      </div>
    </a>
  
  
    <a href="/2023/07/29/matplotlib-notes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Matplotlib Notes</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai/" rel="tag">ai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/conda/" rel="tag">conda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/data-analysis/" rel="tag">data_analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jpa/" rel="tag">jpa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/matplotlib/" rel="tag">matplotlib</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ollama/" rel="tag">ollama</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pandas/" rel="tag">pandas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plot/" rel="tag">plot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/powerbi/" rel="tag">powerbi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ai/" style="font-size: 10px;">ai</a> <a href="/tags/conda/" style="font-size: 10px;">conda</a> <a href="/tags/data-analysis/" style="font-size: 20px;">data_analysis</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jpa/" style="font-size: 10px;">jpa</a> <a href="/tags/matplotlib/" style="font-size: 10px;">matplotlib</a> <a href="/tags/ollama/" style="font-size: 10px;">ollama</a> <a href="/tags/pandas/" style="font-size: 16.67px;">pandas</a> <a href="/tags/plot/" style="font-size: 10px;">plot</a> <a href="/tags/powerbi/" style="font-size: 10px;">powerbi</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/spring/" style="font-size: 10px;">spring</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/16/time-series-analysis-seasonal-pattern/">Data Reveals - Seasonal Patterns in the Equity Market - Is the ‘Sell in May and Go Away, Come Back in September’ Strategy Reliable?</a>
          </li>
        
          <li>
            <a href="/2024/06/02/python-pandas-vs-powerbi/">Python &amp; Pandas VS Power BI for Data Cleaning</a>
          </li>
        
          <li>
            <a href="/2024/05/04/monte-carlo-stock-portfolio/">Monte Carlo Simulation using Python</a>
          </li>
        
          <li>
            <a href="/2024/04/21/data-analysis-ivv/">Time Series Analysis For IVV.US</a>
          </li>
        
          <li>
            <a href="/2024/04/01/local-private-AI/">Your Local Private AI Assistant</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 K.Z.<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>